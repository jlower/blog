---
title: 2025.11–2026实习相关整理2
date: 2025-12-15 03:00:00
categories: [实习项目]
keywords: [实习项目,实习,Go,Node.js,TypeScript,面经]
tag: []
description:
---

## 问题排查和避坑文档整理

## 案例：DAO服务全表查询导致服务频繁重启

### 问题现象
DAO（数据访问对象）服务间隔一段时间就重启，但日志中没有明显的OOM（内存溢出）错误。排查发现，当有查询执行对十几万乃至上百万数据表的全表扫描时，服务就会重启。

### 根因分析

1. 接口设计缺乏安全护栏：DAO服务提供了全量查询接口且没有分页或数据量限制。这是一个非常危险的设计。当表数据量较小时可能没问题，一旦数据量增长到一定程度，必然成为性能炸弹。
2. 资源管理不当：大查询会耗尽数据库连接、网络带宽和服务本身的内存/CPU资源，导致服务不可用进而重启。代码层面对这种“慢查询”或“大查询”没有超时中断或资源保护机制。
3. 问题排查困难：由于服务重启瞬间的日志丢失，以及最初没有配置正确的进程管理器来上报重启日志，导致问题定位耗时较长。

### 解决措施

1. 紧急措施：在DAO服务中拦截并禁用这两个危险的全量查询SQL。
2. 长远解决：重构接口，强制进行分页查询，并增加查询超时设置。

### 经验教训与启示
1. 启示一（接口设计）：在设计数据查询接口时，必须将“分页"作为首要考虑因素。对于后台需要全量数据的场景，也应通过流式处理或分批查询来实现，避免一次性加载所有数据。
2. 启示二（资源边界）：任何服务都必须清楚自己的资源边界（CPU、内存、数据库连接等），并对可能突破边界的操作进行限制和防护。
3. 启示三（可观测性）：完善的日志、监控和告警是快速定位问题的生命线。服务异常重启的告警应该第一时间触发。

### 最佳实践

#### MySQL 最佳实践

1. 需要定时 全表扫描 更新索引，分批拉取（每次最多不超过 1000 条），不能全表一次拉取。
2. 统一搜索中，需要盘点所有的可用数据资产，包括 dao 中已有数据，按搜索类别构建索引：要应用 高性能分页查询。

#### 消息队列最佳实践

1. 消息幂等性（最核心）- 必须在业务层实现幂等。不要依赖消息引擎不投递重复消息，应使用业务唯一键（如MessageID）配合数据库唯一索引进行防重执行。
2. 消费端最佳实践 - 消费端位移管理： 必须对消费确认。
